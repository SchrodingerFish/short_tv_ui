# 项目启动和测试说明

## 问题修复

已修复以下问题:

### 1. Service Worker 注册失败
- ✅ 创建了 `public/sw.js` 文件
- ✅ 实现了视频缓存功能
- ✅ 在 `main.jsx` 中注册 Service Worker
- ✅ 创建了 `serviceWorker.js` 工具函数

### 2. 视频播放失败
- ✅ 添加了 `crossOrigin="anonymous"` 属性处理CORS
- ✅ 优化了自动播放逻辑
- ✅ 添加了错误处理和重试功能
- ✅ 改进了视频加载流程
- ✅ 添加了视频错误提示和重试按钮

### 3. 播放器重试问题优化
- ✅ 减少API重试次数（从2次降至1次），避免过度重试
- ✅ 优化VideoPlayer重试逻辑（从3次降至2次）
- ✅ 只对网络错误进行重试，不对格式错误等无法恢复的错误重试
- ✅ 改进错误提示信息，更清晰地告知用户错误原因
- ✅ 优化播放器初始化流程，确保从列表页进入能直接播放第一集

### 4. CORS跨域问题优化
- ✅ 配置Vite代理，开发环境下代理API请求到第三方服务器
- ✅ 改进API配置，自动区分开发和生产环境
- ✅ 优化Service Worker的视频缓存策略，跳过跨域视频避免CORS错误
- ✅ API请求不再缓存，确保数据实时性
- ✅ 增加请求超时时间到20秒，避免过早超时

## 启动步骤

1. **安装依赖**
```bash
npm install
```

2. **启动开发服务器**
```bash
npm run dev
```

3. **构建生产版本**
```bash
npm run build
```

## 注意事项

### Service Worker
- Service Worker 需要在 HTTPS 或 localhost 环境下运行
- 首次访问时会注册 SW，刷新后生效
- 控制台会显示注册状态

### 视频播放
- 某些浏览器需要用户交互才能自动播放
- 如果自动播放失败，点击播放按钮即可
- 添加了错误提示和重试功能

### 跨域问题
- 开发环境使用Vite代理解决CORS问题，所有API请求会通过 `/api` 代理到第三方服务器
- 生产环境需要确保API服务器配置了正确的CORS头
- Service Worker跳过跨域视频请求的缓存，避免CORS错误
- 如果生产环境遇到CORS问题，可以考虑使用服务端代理或配置Nginx反向代理

## 功能测试清单

- [ ] Service Worker 注册成功
- [ ] 分类加载和切换
- [ ] 搜索功能
- [ ] 随机推荐
- [ ] 视频播放
- [ ] 长按倍速
- [ ] 剧集切换
- [ ] 自动播放下一集
- [ ] 分页功能
- [ ] 移动端响应式

## 调试技巧

1. 打开浏览器开发者工具
2. 查看 Console 面板的日志
3. 检查 Network 面板的请求
4. Application > Service Workers 查看 SW 状态
5. 如有问题，查看错误信息并反馈
